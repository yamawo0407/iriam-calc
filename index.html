<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRIAM詳細シミュレーター</title>
    <style>
        :root { --primary: #ff4500; --bg: #f5f7fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: #333; font-size: 14px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        h1 { color: var(--primary); font-size: 1.1rem; text-align: center; margin-top: 0; }
        
        .setup-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #fff5f0; padding: 10px; border-radius: 8px; }
        label { font-size: 0.7rem; color: #666; display: block; margin-bottom: 2px; }
        select, input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        .scroll-container { overflow-x: auto; margin-top: 15px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #eee; position: sticky; top: 0; z-index: 10; font-size: 0.75rem; }
        th, td { border: 1px solid #eee; padding: 6px 4px; text-align: center; }
        
        input.daily-input { width: 45px; padding: 4px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .pass-chk { transform: scale(1.2); }
        
        .up { background: #fff5f5; color: #e53e3e; font-weight: bold; }
        .down { background: #ebf8ff; color: #3182ce; }
        .keep { background: #f0fff4; color: #38a169; }
        .pass-row { background: #f9f9f9; color: #999; }

        .btn-area { position: sticky; bottom: 10px; background: white; padding: 10px 0; text-align: center; border-top: 1px solid #eee; }
        button { padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

<div class="card">
    <h1>IRIAM詳細シミュレーター (60日)</h1>
    
    <div class="setup-area">
        <div>
            <label>初期ランク</label>
            <select id="init-rank">
                <option value="D">D</option><option value="C1">C1</option><option value="C2">C2</option>
                <option value="C3">C3</option><option value="C4">C4</option><option value="C5">C5</option>
                <option value="B1">B1</option><option value="B2">B2</option><option value="B3">B3</option>
                <option value="A1">A1</option><option value="A2">A2</option><option value="A3">A3</option>
                <option value="S1">S1</option><option value="S2">S2</option><option value="S3">S3</option>
            </select>
        </div>
        <div>
            <label>初期残り日数(6〜0)</label>
            <input type="number" id="init-days" value="6" min="0" max="6">
        </div>
    </div>

    <div class="scroll-container">
        <table id="sim-table">
            <thead>
                <tr>
                    <th>日付</th>
                    <th>パス</th>
                    <th>予定pt</th>
                    <th>ランク</th>
                    <th>残り</th>
                    <th>累計</th>
                    <th>判定</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>

    <div class="btn-area">
        <button onclick="runSimulation()">計算を更新して保存</button>
    </div>
</div>

<script>
    const RANKS = ["D", "C1", "C2", "C3", "C4", "C5", "B1", "B2", "B3", "A1", "A2", "A3", "S1", "S2", "S3"];
    const DAYS_COUNT = 60;

    // 初期表示
    window.onload = () => {
        loadData();
        renderRows();
        runSimulation();
    };

    function renderRows() {
        const tbody = document.getElementById('table-body');
        let date = new Date();
        for (let i = 0; i < DAYS_COUNT; i++) {
            let dateStr = (date.getMonth() + 1) + "/" + date.getDate();
            let tr = document.createElement('tr');
            tr.id = `row-${i}`;
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td><input type="checkbox" class="pass-chk" id="pass-${i}" onchange="runSimulation()"></td>
                <td><input type="number" class="daily-input" id="score-${i}" value="2" oninput="runSimulation()"></td>
                <td id="rank-${i}">-</td>
                <td id="rem-${i}">-</td>
                <td id="total-${i}">-</td>
                <td id="status-${i}">-</td>
            `;
            tbody.appendChild(tr);
            date.setDate(date.getDate() + 1);
        }
    }

    function runSimulation() {
        let curRank = document.getElementById('init-rank').value;
        let dayRem = parseInt(document.getElementById('init-days').value);
        let total = 0;
        let dataToSave = { scores: [], passes: [], initRank: curRank, initDays: dayRem };

        for (let i = 0; i < DAYS_COUNT; i++) {
            let isPass = document.getElementById(`pass-${i}`).checked;
            let dailyAdd = parseInt(document.getElementById(`score-${i}`).value) || 0;
            let status = "-";
            let isEnd = false;

            dataToSave.scores.push(dailyAdd);
            dataToSave.passes.push(isPass);

            if (isPass) {
                // スキップパス使用時：ランク・日数は変動しない
                status = "PASS";
                document.getElementById(`row-${i}`).className = "pass-row";
            } else {
                total += dailyAdd;
                document.getElementById(`row-${i}`).className = "";

                if (total >= 18) {
                    status = "アップ";
                    isEnd = true;
                } else if (dayRem <= 0) {
                    status = (total >= 12) ? "キープ" : "ダウン";
                    isEnd = true;
                }
            }

            // 表示更新
            document.getElementById(`rank-${i}`).innerText = curRank;
            document.getElementById(`rem-${i}`).innerText = isPass ? "-" : dayRem + "日";
            document.getElementById(`total-${i}`).innerText = isPass ? "-" : total + "pt";
            let statusCell = document.getElementById(`status-${i}`);
            statusCell.innerText = status;
            statusCell.className = (status === "アップ") ? "up" : (status === "ダウン" ? "down" : (status === "キープ" ? "keep" : ""));

            if (!isPass && isEnd) {
                let idx = RANKS.indexOf(curRank);
                if (status === "アップ" && idx < RANKS.length - 1) curRank = RANKS[idx + 1];
                else if (status === "ダウン" && idx > 0) curRank = RANKS[idx - 1];
                total = 0;
                dayRem = 6;
            } else if (!isPass) {
                dayRem--;
            }
        }
        localStorage.setItem('iriam_sim_data', JSON.stringify(dataToSave));
    }

    function loadData() {
        let saved = localStorage.getItem('iriam_sim_data');
        if (!saved) return;
        let data = JSON.parse(saved);
        document.getElementById('init-rank').value = data.initRank;
        document.getElementById('init-days').value = data.initDays;
        
        // データの復元はrenderRowsの後に行う必要があるため、runSimulation内で初期値をセット
        setTimeout(() => {
            for (let i = 0; i < DAYS_COUNT; i++) {
                if(data.scores[i] !== undefined) document.getElementById(`score-${i}`).value = data.scores[i];
                if(data.passes[i] !== undefined) document.getElementById(`pass-${i}`).checked = data.passes[i];
            }
            runSimulation();
        }, 100);
    }
</script>

</body>
</html>
